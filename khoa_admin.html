<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω L·ªùi Ch√∫c - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Cormorant+Garamond:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --color-primary: #d4af37;
        --color-secondary: #aa8f3b;
        --color-dark: #1a1a2e;
        --color-light: #ffffff;
        --color-gray: #c7c7c7;
        --spacing-xs: 0.5rem;
        --spacing-sm: 1rem;
        --spacing-md: 1.5rem;
        --spacing-lg: 2rem;
        --spacing-xl: 3rem;
        --radius-sm: 8px;
        --radius-md: 16px;
        --radius-lg: 24px;
        --shadow-md: 0 10px 40px rgba(0, 0, 0, 0.2);
        --shadow-gold: 0 10px 40px rgba(212, 175, 55, 0.4);
      }

      body {
        font-family: "Montserrat", sans-serif;
        background: var(--color-dark);
        color: var(--color-light);
        min-height: 100vh;
        padding: var(--spacing-lg);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: var(--spacing-xl);
        padding: var(--spacing-lg);
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
      }

      .header h1 {
        font-family: "Cormorant Garamond", serif;
        font-size: 2.5rem;
        background: linear-gradient(
          135deg,
          #d4af37 0%,
          #aa8f3b 50%,
          #d4af37 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: var(--spacing-sm);
      }

      .header p {
        color: var(--color-gray);
        font-size: 1rem;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
      }

      .stat-card {
        background: rgba(212, 175, 55, 0.1);
        border: 2px solid rgba(212, 175, 55, 0.3);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        text-align: center;
      }

      .stat-card-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--color-primary);
        margin-bottom: var(--spacing-xs);
      }

      .stat-card-label {
        font-size: 0.9rem;
        color: var(--color-gray);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .controls {
        display: flex;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        flex-wrap: wrap;
      }

      .btn {
        padding: var(--spacing-sm) var(--spacing-lg);
        border: none;
        border-radius: var(--radius-md);
        font-family: "Montserrat", sans-serif;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #d4af37 0%, #aa8f3b 100%);
        color: var(--color-dark);
        box-shadow: var(--shadow-gold);
      }

      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 50px rgba(212, 175, 55, 0.6);
      }

      .btn-secondary {
        background: rgba(212, 175, 55, 0.1);
        color: var(--color-light);
        border: 2px solid var(--color-primary);
      }

      .btn-secondary:hover {
        background: rgba(212, 175, 55, 0.2);
        transform: translateY(-3px);
      }

      .filter-section {
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-md);
        background: rgba(212, 175, 55, 0.05);
        border-radius: var(--radius-md);
        border: 1px solid rgba(212, 175, 55, 0.2);
      }

      .filter-section label {
        display: block;
        margin-bottom: var(--spacing-xs);
        color: var(--color-primary);
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .filter-section select {
        width: 100%;
        padding: var(--spacing-sm);
        background: rgba(12, 12, 20, 0.96);
        border: 2px solid rgba(212, 175, 55, 0.7);
        border-radius: var(--radius-sm);
        color: #fdf5d7;
        font-family: "Montserrat", sans-serif;
        font-size: 1rem;
        font-weight: 600;
        outline: none;
        transition: all 0.3s ease;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
      }

      /* M√†u ch·ªØ option khi m·ªü dropdown (h·∫°n ch·∫ø, nh∆∞ng gi√∫p c·∫£i thi·ªán tr√™n nhi·ªÅu tr√¨nh duy·ªát) */
      .filter-section select option {
        background: #111322;
        color: #fdf5d7;
      }

      .filter-section select:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
      }

      .wishes-container {
        display: grid;
        gap: var(--spacing-md);
      }

      .guest-section {
        background: rgba(212, 175, 55, 0.05);
        border: 2px solid rgba(212, 175, 55, 0.2);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
      }

      .guest-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
        padding-bottom: var(--spacing-md);
        border-bottom: 2px solid rgba(212, 175, 55, 0.3);
      }

      .guest-section-actions {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
      }

      .btn-delete-guest {
        padding: var(--spacing-xs) var(--spacing-sm);
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid rgba(244, 67, 54, 0.5);
        border-radius: var(--radius-sm);
        color: #ef5350;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: "Montserrat", sans-serif;
      }

      .btn-delete-guest:hover {
        background: rgba(244, 67, 54, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
      }

      .guest-section-title {
        font-family: "Cormorant Garamond", serif;
        font-size: 1.8rem;
        color: var(--color-primary);
        font-weight: 700;
      }

      .guest-section-count {
        background: rgba(212, 175, 55, 0.2);
        padding: var(--spacing-xs) var(--spacing-md);
        border-radius: var(--radius-sm);
        font-size: 0.9rem;
        color: var(--color-light);
      }

      .wishes-list {
        display: grid;
        gap: var(--spacing-md);
      }

      .wish-item {
        background: rgba(212, 175, 55, 0.08);
        border-left: 4px solid var(--color-primary);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);
        transition: all 0.3s ease;
      }

      .wish-item:hover {
        background: rgba(212, 175, 55, 0.15);
        transform: translateX(5px);
        box-shadow: 0 5px 20px rgba(212, 175, 55, 0.2);
      }

      .wish-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-xs);
      }

      .wish-item-name {
        font-weight: 600;
        color: var(--color-primary);
        font-size: 1.1rem;
      }

      .wish-item-date {
        font-size: 0.85rem;
        color: var(--color-gray);
      }

      .wish-item-message {
        color: var(--color-light);
        line-height: 1.6;
        margin-top: var(--spacing-xs);
        font-style: italic;
      }

      .empty-state {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--color-gray);
        font-style: italic;
      }

      .loading {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--color-primary);
      }

      .alert {
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-lg);
        animation: fadeIn 0.3s ease;
      }

      .alert-success {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid rgba(76, 175, 80, 0.5);
        color: #81c784;
      }

      .alert-error {
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid rgba(244, 67, 54, 0.5);
        color: #ef5350;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 2rem;
        }

        .stats {
          grid-template-columns: 1fr;
        }

        .controls {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }

        .guest-section-header {
          flex-direction: column;
          align-items: flex-start;
          gap: var(--spacing-sm);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üíù Qu·∫£n L√Ω L·ªùi Ch√∫c</h1>
        <p>Xem t·∫•t c·∫£ l·ªùi ch√∫c m·ª´ng sinh nh·∫≠t t·ª´ m·ªçi ng∆∞·ªùi</p>
      </div>

      <div id="alertContainer"></div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-card-number" id="totalWishes">0</div>
          <div class="stat-card-label">T·ªïng L·ªùi Ch√∫c</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-number" id="totalGuests">0</div>
          <div class="stat-card-label">S·ªë Kh√°ch M·ªùi</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-number" id="todayWishes">0</div>
          <div class="stat-card-label">H√¥m Nay</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="loadAllWishes()">
          üîÑ T·∫£i L·∫°i
        </button>
        <button class="btn btn-secondary" onclick="exportWishes()">
          üì• Xu·∫•t File JSON
        </button>
        <button
          class="btn btn-secondary"
          onclick="document.getElementById('importFile').click()"
        >
          üì§ Nh·∫≠p File JSON
        </button>
        <input
          type="file"
          id="importFile"
          accept=".json"
          style="display: none"
          onchange="importWishes(event)"
        />
        <button
          class="btn btn-danger"
          onclick="confirmResetAll()"
          style="
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: var(--color-light);
            box-shadow: 0 10px 40px rgba(244, 67, 54, 0.4);
          "
        >
          üóëÔ∏è Reset T·∫•t C·∫£ L·ªùi Ch√∫c
        </button>
      </div>

      <div class="filter-section">
        <label for="guestFilter">L·ªçc theo kh√°ch m·ªùi:</label>
        <select id="guestFilter" onchange="filterByGuest()">
          <option value="all">T·∫•t c·∫£ kh√°ch m·ªùi</option>
        </select>
      </div>

      <div class="wishes-container" id="wishesContainer">
        <div class="loading">ƒêang t·∫£i l·ªùi ch√∫c...</div>
      </div>
    </div>

    <script>
      // ===================================
      // JSONBin.io Configuration (ph·∫£i gi·ªëng v·ªõi index.html)
      // ===================================
      const WISHES_CONFIG = {
        jsonbinId: "692fbfb4ae596e708f7fedb3",
        jsonbinApiKey:
          "$2a$10$quAPh3s4iAAsLsdYmm9cWOH/L1vSkpnwT3A1ychK0lxDrQS0BDdBS",
        jsonbinUrl: "https://api.jsonbin.io/v3/b",
        useCloud: true,
      };

      let allWishesData = {};
      let currentFilter = "all";

      // Load t·∫•t c·∫£ wishes t·ª´ cloud
      async function loadAllWishesFromCloud() {
        if (!WISHES_CONFIG.useCloud || !WISHES_CONFIG.jsonbinId) {
          return {};
        }

        try {
          const url = `${WISHES_CONFIG.jsonbinUrl}/${WISHES_CONFIG.jsonbinId}/latest`;
          const headers = {
            "Content-Type": "application/json",
          };

          if (WISHES_CONFIG.jsonbinApiKey) {
            headers["X-Master-Key"] = WISHES_CONFIG.jsonbinApiKey;
          }

          const response = await fetch(url, { headers });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          // Format: { "nguyen-van-a": [...], ... }
          return data.record || {};
        } catch (error) {
          console.error("L·ªói khi load t·ª´ cloud:", error);
          return {};
        }
      }

      // L·∫•y t·∫•t c·∫£ keys t·ª´ localStorage c√≥ ch·ª©a "birthday_wishes"
      function getAllWishesKeys() {
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith("birthday_wishes_")) {
            keys.push(key);
          }
        }
        return keys;
      }

      // L·∫•y slug t·ª´ key (birthday_wishes_nguyen-van-a -> nguyen-van-a)
      function getSlugFromKey(key) {
        return key.replace("birthday_wishes_", "");
      }

      // Load t·∫•t c·∫£ l·ªùi ch√∫c t·ª´ cloud v√† localStorage
      async function loadAllWishes() {
        const container = document.getElementById("wishesContainer");
        container.innerHTML =
          '<div class="loading">ƒêang t·∫£i l·ªùi ch√∫c t·ª´ cloud...</div>';

        allWishesData = {};

        // 1. Load t·ª´ cloud (∆∞u ti√™n)
        if (WISHES_CONFIG.useCloud && WISHES_CONFIG.jsonbinId) {
          try {
            const cloudData = await loadAllWishesFromCloud();
            // Merge v√†o allWishesData
            Object.keys(cloudData).forEach((slug) => {
              if (
                Array.isArray(cloudData[slug]) &&
                cloudData[slug].length > 0
              ) {
                allWishesData[slug] = cloudData[slug];
              }
            });
            console.log(
              "‚úÖ ƒê√£ load t·ª´ cloud:",
              Object.keys(allWishesData).length,
              "guests"
            );
          } catch (error) {
            console.warn("Kh√¥ng th·ªÉ load t·ª´ cloud, d√πng localStorage:", error);
          }
        }

        // 2. Load t·ª´ localStorage (fallback v√† merge)
        const keys = getAllWishesKeys();
        keys.forEach((key) => {
          try {
            const stored = localStorage.getItem(key);
            if (stored) {
              const wishes = JSON.parse(stored);
              const slug = getSlugFromKey(key);
              if (Array.isArray(wishes) && wishes.length > 0) {
                // Merge v·ªõi cloud data (∆∞u ti√™n cloud)
                if (!allWishesData[slug]) {
                  allWishesData[slug] = wishes;
                } else {
                  // Merge v√† lo·∫°i b·ªè duplicate
                  const existingIds = new Set(
                    allWishesData[slug].map((w) => w.id)
                  );
                  const newWishes = wishes.filter(
                    (w) => !existingIds.has(w.id)
                  );
                  allWishesData[slug] = [...allWishesData[slug], ...newWishes];
                }
              }
            }
          } catch (error) {
            console.error(`L·ªói khi ƒë·ªçc ${key}:`, error);
          }
        });

        // S·∫Øp x·∫øp l·∫°i m·ªói guest theo timestamp
        Object.keys(allWishesData).forEach((slug) => {
          allWishesData[slug].sort(
            (a, b) => (b.timestamp || 0) - (a.timestamp || 0)
          );
        });

        updateStats();
        updateGuestFilter();
        renderWishes();
      }

      // C·∫≠p nh·∫≠t th·ªëng k√™
      function updateStats() {
        let totalWishes = 0;
        let todayWishes = 0;
        const today = new Date().toDateString();

        Object.values(allWishesData).forEach((wishes) => {
          totalWishes += wishes.length;
          wishes.forEach((wish) => {
            const wishDate = new Date(wish.date).toDateString();
            if (wishDate === today) {
              todayWishes++;
            }
          });
        });

        document.getElementById("totalWishes").textContent = totalWishes;
        document.getElementById("totalGuests").textContent =
          Object.keys(allWishesData).length;
        document.getElementById("todayWishes").textContent = todayWishes;
      }

      // C·∫≠p nh·∫≠t dropdown filter
      function updateGuestFilter() {
        const select = document.getElementById("guestFilter");
        const currentValue = select.value;

        // X√≥a t·∫•t c·∫£ options tr·ª´ "all"
        select.innerHTML = '<option value="all">T·∫•t c·∫£ kh√°ch m·ªùi</option>';

        // Th√™m options cho m·ªói guest
        Object.keys(allWishesData).forEach((slug) => {
          const option = document.createElement("option");
          option.value = slug;
          option.textContent = formatSlug(slug);
          select.appendChild(option);
        });

        // Gi·ªØ l·∫°i gi√° tr·ªã c≈© n·∫øu c√≤n t·ªìn t·∫°i
        if (currentValue && allWishesData[currentValue]) {
          select.value = currentValue;
        } else {
          select.value = "all";
        }

        currentFilter = select.value;
      }

      // Format slug th√†nh t√™n ƒë·∫πp h∆°n
      function formatSlug(slug) {
        return slug
          .split("-")
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      // Format ng√†y th√°ng
      function formatDate(dateString) {
        try {
          const date = new Date(dateString);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);

          if (diffMins < 1) {
            return "V·ª´a xong";
          } else if (diffMins < 60) {
            return `${diffMins} ph√∫t tr∆∞·ªõc`;
          } else if (diffHours < 24) {
            return `${diffHours} gi·ªù tr∆∞·ªõc`;
          } else if (diffDays < 7) {
            return `${diffDays} ng√†y tr∆∞·ªõc`;
          } else {
            return date.toLocaleDateString("vi-VN", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });
          }
        } catch (error) {
          return dateString;
        }
      }

      // Escape HTML ƒë·ªÉ tr√°nh XSS
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Render l·ªùi ch√∫c
      function renderWishes() {
        const container = document.getElementById("wishesContainer");

        if (Object.keys(allWishesData).length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>Ch∆∞a c√≥ l·ªùi ch√∫c n√†o. H√£y m·ªü thi·ªáp v√† g·ª≠i l·ªùi ch√∫c ƒë·∫ßu ti√™n! üíù</p>
            </div>
          `;
          return;
        }

        let html = "";

        // N·∫øu filter l√† "all", hi·ªÉn th·ªã t·∫•t c·∫£
        if (currentFilter === "all") {
          Object.keys(allWishesData).forEach((slug) => {
            html += renderGuestSection(slug, allWishesData[slug]);
          });
        } else {
          // Ch·ªâ hi·ªÉn th·ªã guest ƒë∆∞·ª£c ch·ªçn
          if (allWishesData[currentFilter]) {
            html = renderGuestSection(
              currentFilter,
              allWishesData[currentFilter]
            );
          }
        }

        container.innerHTML =
          html ||
          `
          <div class="empty-state">
            <p>Kh√¥ng t√¨m th·∫•y l·ªùi ch√∫c n√†o.</p>
          </div>
        `;
      }

      // Render section cho m·ªôt guest
      function renderGuestSection(slug, wishes) {
        const sortedWishes = [...wishes].sort(
          (a, b) => new Date(b.date) - new Date(a.date)
        );

        let html = `
          <div class="guest-section" data-guest-slug="${escapeHtml(slug)}">
            <div class="guest-section-header">
              <div class="guest-section-title">${escapeHtml(
                formatSlug(slug)
              )}</div>
              <div class="guest-section-actions">
                <div class="guest-section-count">${
                  sortedWishes.length
                } l·ªùi ch√∫c</div>
                <button 
                  class="btn-delete-guest" 
                  onclick="confirmDeleteGuest('${escapeHtml(slug)}')"
                  title="X√≥a t·∫•t c·∫£ l·ªùi ch√∫c c·ªßa ${escapeHtml(
                    formatSlug(slug)
                  )}"
                >
                  üóëÔ∏è X√≥a
                </button>
              </div>
            </div>
            <div class="wishes-list">
        `;

        sortedWishes.forEach((wish) => {
          html += `
            <div class="wish-item">
              <div class="wish-item-header">
                <div class="wish-item-name">${escapeHtml(wish.name)}</div>
                <div class="wish-item-date">${formatDate(wish.date)}</div>
              </div>
              <div class="wish-item-message">${escapeHtml(wish.message)}</div>
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;

        return html;
      }

      // Filter theo guest
      function filterByGuest() {
        const select = document.getElementById("guestFilter");
        currentFilter = select.value;
        renderWishes();
      }

      // Export t·∫•t c·∫£ l·ªùi ch√∫c ra file JSON
      function exportWishes() {
        try {
          const dataStr = JSON.stringify(allWishesData, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `birthday-wishes-${
            new Date().toISOString().split("T")[0]
          }.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          showAlert("Xu·∫•t file th√†nh c√¥ng! ‚úÖ", "success");
        } catch (error) {
          console.error("L·ªói khi xu·∫•t file:", error);
          showAlert("L·ªói khi xu·∫•t file! ‚ùå", "error");
        }
      }

      // Import l·ªùi ch√∫c t·ª´ file JSON
      function importWishes(event) {
        const file = event.target.files[0];
        if (!file) {
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const importedData = JSON.parse(e.target.result);

            // Merge v·ªõi d·ªØ li·ªáu hi·ªán t·∫°i
            Object.keys(importedData).forEach((slug) => {
              if (Array.isArray(importedData[slug])) {
                const key = `birthday_wishes_${slug}`;
                const existing = localStorage.getItem(key);
                let existingWishes = [];

                if (existing) {
                  try {
                    existingWishes = JSON.parse(existing);
                  } catch (err) {
                    console.warn(`L·ªói khi ƒë·ªçc d·ªØ li·ªáu c≈© c·ªßa ${slug}`);
                  }
                }

                // Merge v√† lo·∫°i b·ªè tr√πng l·∫∑p d·ª±a tr√™n id
                const existingIds = new Set(existingWishes.map((w) => w.id));
                const newWishes = importedData[slug].filter(
                  (w) => !existingIds.has(w.id)
                );

                const merged = [...existingWishes, ...newWishes];
                localStorage.setItem(key, JSON.stringify(merged));
              }
            });

            showAlert("Nh·∫≠p file th√†nh c√¥ng! ‚úÖ", "success");
            loadAllWishes();
          } catch (error) {
            console.error("L·ªói khi nh·∫≠p file:", error);
            showAlert(
              "L·ªói khi nh·∫≠p file! Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng JSON. ‚ùå",
              "error"
            );
          }
        };

        reader.readAsText(file);
        event.target.value = ""; // Reset input
      }

      // Hi·ªÉn th·ªã th√¥ng b√°o
      function showAlert(message, type) {
        const container = document.getElementById("alertContainer");
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        container.appendChild(alert);

        setTimeout(() => {
          alert.remove();
        }, 3000);
      }

      // Reset t·∫•t c·∫£ l·ªùi ch√∫c
      function resetAllWishes() {
        try {
          const keysToDelete = getAllWishesKeys();
          let count = 0;

          keysToDelete.forEach((key) => {
            localStorage.removeItem(key);
            count++;
          });

          allWishesData = {};
          updateStats();
          updateGuestFilter();
          renderWishes();

          showAlert(`ƒê√£ x√≥a ${count} l·ªùi ch√∫c! ‚úÖ`, "success");
          console.log(`‚úÖ ƒê√£ reset ${count} l·ªùi ch√∫c`);
        } catch (error) {
          console.error("L·ªói khi reset l·ªùi ch√∫c:", error);
          showAlert("C√≥ l·ªói x·∫£y ra khi reset l·ªùi ch√∫c! ‚ùå", "error");
        }
      }

      // X√≥a l·ªùi ch√∫c c·ªßa m·ªôt guest c·ª• th·ªÉ
      function deleteGuestWishes(slug) {
        try {
          const key = `birthday_wishes_${slug}`;
          const existed = localStorage.getItem(key);

          if (!existed) {
            showAlert(
              `Kh√¥ng t√¨m th·∫•y l·ªùi ch√∫c c·ªßa ${formatSlug(slug)}.`,
              "error"
            );
            return;
          }

          const wishes = JSON.parse(existed);
          const count = wishes.length;

          localStorage.removeItem(key);
          delete allWishesData[slug];

          updateStats();
          updateGuestFilter();
          renderWishes();

          showAlert(
            `ƒê√£ x√≥a ${count} l·ªùi ch√∫c c·ªßa ${formatSlug(slug)}! ‚úÖ`,
            "success"
          );
          console.log(`‚úÖ ƒê√£ x√≥a ${count} l·ªùi ch√∫c c·ªßa ${slug}`);
        } catch (error) {
          console.error("L·ªói khi x√≥a l·ªùi ch√∫c:", error);
          showAlert("C√≥ l·ªói x·∫£y ra khi x√≥a l·ªùi ch√∫c! ‚ùå", "error");
        }
      }

      // X√°c nh·∫≠n x√≥a l·ªùi ch√∫c c·ªßa m·ªôt guest
      function confirmDeleteGuest(slug) {
        if (!allWishesData[slug] || allWishesData[slug].length === 0) {
          showAlert(
            `Kh√¥ng c√≥ l·ªùi ch√∫c n√†o c·ªßa ${formatSlug(slug)} ƒë·ªÉ x√≥a.`,
            "error"
          );
          return;
        }

        const count = allWishesData[slug].length;
        const guestName = formatSlug(slug);

        const confirmed = confirm(
          `‚ö†Ô∏è C·∫¢NH B√ÅO!\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${count} l·ªùi ch√∫c c·ªßa "${guestName}"?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`
        );

        if (confirmed) {
          deleteGuestWishes(slug);
        }
      }

      // X√°c nh·∫≠n reset v·ªõi c·∫£nh b√°o
      function confirmResetAll() {
        const total = Object.values(allWishesData).reduce(
          (sum, wishes) => sum + wishes.length,
          0
        );

        if (total === 0) {
          showAlert("Kh√¥ng c√≥ l·ªùi ch√∫c n√†o ƒë·ªÉ x√≥a.", "error");
          return;
        }

        const confirmed = confirm(
          `‚ö†Ô∏è C·∫¢NH B√ÅO!\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ ${total} l·ªùi ch√∫c c·ªßa T·∫§T C·∫¢ guests?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`
        );

        if (confirmed) {
          const doubleConfirm = confirm(
            "X√°c nh·∫≠n l·∫ßn cu·ªëi: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ l·ªùi ch√∫c c·ªßa T·∫§T C·∫¢ guests?"
          );

          if (doubleConfirm) {
            resetAllWishes();
          }
        }
      }

      // Kh·ªüi t·∫°o
      window.addEventListener("DOMContentLoaded", () => {
        loadAllWishes();

        // Auto refresh m·ªói 30 gi√¢y
        setInterval(() => {
          loadAllWishes();
        }, 30000);
      });
    </script>
  </body>
</html>
